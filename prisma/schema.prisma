// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// üßò CON NHANG (USER MODEL)
// ==========================================
model ConNhang {
  idString      String       @id @default(uuid())
  email         String       @unique
  phapDanh      String?      // Username (VD: Th√≠ch Code D·∫°o)
  password      String       // Hash (Argon2id)
  phoneNumber   String?      @unique
  walletAddress String?      // Solana Wallet cho NFT

  // --- ROLE & STATUS ---
  role          SystemRole   @default(MEMBER)
  isActive      Boolean      @default(true)

  // --- RANK SYSTEM ---
  rank          MemberRank   @default(TU_TAI_GIA)
  rankExpiryDate DateTime?   // Ng√†y h·∫øt h·∫°n Rank (Cronjob s·∫Ω qu√©t c√°i n√†y)
  
  // --- KARMA ECONOMY ---
  currentKarma  Int          @default(0) // ƒêi·ªÉm hi·ªán t·∫°i
  totalDonated  Decimal      @default(0) @db.Decimal(19, 4) // T·ªïng ti·ªÅn ƒë√£ n·∫°p (ƒë·ªÉ x√©t l√™n Rank)
  
  // --- AFK FARMING ---
  lastKnockTime DateTime?    // Ch·ªëng spam click
  isAutoKnock   Boolean      @default(false) // Ch·ªâ VIP m·ªõi true

  // --- RELATIONS ---
  donations     Donation[]
  bookings      Booking[]
  karmaLogs     KarmaLog[]

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([rank])
  @@index([role])
  @@index([rankExpiryDate]) // T·ªëi ∆∞u cho Cronjob qu√©t h·∫øt h·∫°n
  @@map("con_nhang")
}

// ==========================================
// üí∏ C√öNG D∆Ø·ªúNG (DONATION)
// ==========================================
model Donation {
  id            String         @id @default(uuid())
  amount        Decimal        @db.Decimal(19, 4)
  currency      String         @default("VND")
  message       String?        @db.Text // L·ªùi kh·∫•n (ƒë·ªÉ ch·∫°y Marquee)
  status        DonationStatus @default(PENDING)
  transactionId String?        // M√£ giao d·ªãch t·ª´ c·ªïng thanh to√°n (Momo/Stripe)

  // --- RELATIONS ---
  conNhangId    String
  conNhang      ConNhang       @relation(fields: [conNhangId], references: [idString])

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@map("donations")
}

// ==========================================
// üìÖ KH√ìA TU & BOOKING (PAY-TO-WIN)
// ==========================================
model Booking {
  id            String        @id @default(uuid())
  slotTime      DateTime      // Gi·ªù g·∫∑p th·∫ßy
  status        BookingStatus @default(PENDING)
  
  // --- PRIVILEGE FIELDS (C·ªët l√µi ki·∫øm ti·ªÅn) ---
  isFastTrack   Boolean       @default(false) // V√© ∆∞u ti√™n chen h√†ng
  isPrivateRoom Boolean       @default(false) // Bao ph√≤ng (x3 ti·ªÅn)
  
  // --- RELATIONS ---
  conNhangId    String
  conNhang      ConNhang      @relation(fields: [conNhangId], references: [idString])

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([slotTime]) // T·ªëi ∆∞u query l·ªãch
  @@map("bookings")
}

// ==========================================
// üìú S·ªî NAM T√ÄO (KARMA LOGS)
// ==========================================
model KarmaLog {
  id            String      @id @default(uuid())
  amount        Int         // S·ªë ƒëi·ªÉm (+ ho·∫∑c -)
  source        KarmaSource
  metadata      Json?       // L∆∞u context: { "donationId": "...", "jackpotRound": 1 }
  
  // --- RELATIONS ---
  conNhangId    String
  conNhang      ConNhang    @relation(fields: [conNhangId], references: [idString])

  createdAt     DateTime    @default(now())

  @@map("karma_logs")
}

// ==========================================
// üìø ENUMS (DANH M·ª§C T√ÇM LINH)
// ==========================================
enum MemberRank {
  TU_TAI_GIA  // Free
  A_LA_HAN    // VIP
  BO_TAT      // VVIP
}

enum DonationStatus {
  PENDING
  COMPLETED
  FAILED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum KarmaSource {
  DONATION      // N·∫°p ti·ªÅn
  AFK_FARMING   // Tu online
  JACKPOT       // N·ªï h≈©
  DAILY_CHECKIN // ƒêi·ªÉm danh
  SYSTEM_ADJUST // Admin ch·ªânh s·ª≠a (Nghi·ªáp qu·∫≠t)
  EXPIRED_DEDUCTION // Tr·ª´ ƒëi·ªÉm do h·∫øt h·∫°n
}

enum SystemRole {
  MEMBER
  CHU_TIEU
  SU_TRUONG
  TRU_TRI
}
